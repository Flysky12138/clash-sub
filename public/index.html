<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>clash-sub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui" />
    <!-- vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <!-- vuetify -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  </head>
  <body>
    <div id="app">
      <v-app>
        <v-main>
          <v-container class="mx-auto" :class="{'fill-height': $vuetify.breakpoint.smAndUp}" style="max-width: 700px">
            <v-card outlined rounded="lg">
              <v-card-title style="width: 100%" class="grey lighten-3">
                <a
                  class="text-h4 text-decoration-none font-weight-bold text-uppercase mx-auto success--text"
                  href="https://github.com/Flysky12138/clash-sub"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <template v-if="bypass">
                    <v-badge left overlap color="success" offset-x="0" content="分流">{{text.header}}</v-badge>
                  </template>
                  <template v-else>{{text.header}}</template>
                </a>
                <v-btn absolute right x-small fab elevation="0" color="grey lighten-3" @mousedown.prevent="onClick">
                  <v-icon v-text="bypass?'mdi-pinwheel':'mdi-pinwheel-outline'"></v-icon>
                </v-btn>
              </v-card-title>
              <v-divider width="100%" class="gray"></v-divider>
              <v-card-text>
                <v-row class="mt-3">
                  <v-col cols="12">
                    <v-text-field
                      v-model="from.url"
                      label="订阅地址"
                      placeholder="https://xxx"
                      hint="多个用 , 隔开"
                      outlined
                      clearable
                      dense
                      counter
                      :counter-value="v => v ? v.trim().split(',').filter(res => res.includes('://')).length : 0"
                    ></v-text-field>
                  </v-col>
                  <v-col cols="12">
                    <v-text-field
                      v-model="from.add"
                      label="追加节点"
                      placeholder="vmess://xxx"
                      hint="多个用 , 隔开"
                      outlined
                      clearable
                      dense
                      counter
                      :counter-value="v => v ? v.trim().split(',').filter(res => res.includes('vmess://')).length : 0"
                    ></v-text-field>
                  </v-col>
                  <v-col cols="12">
                    <v-text-field
                      v-model="from.filter"
                      :label="bypass?'国内分组':'节点过滤'"
                      placeholder="香港|新加坡"
                      prefix="/"
                      suffix="/"
                      :hint="`正则匹配。${bypass?'分配匹配的节点到国内分组中，其余分配到国外分组中':'保留匹配到的节点，默认保留所有'}`"
                      outlined
                      clearable
                      dense
                    ></v-text-field>
                  </v-col>
                  <v-col cols="12">
                    <v-text-field v-model="from.host" label="混淆" placeholder="baidu.com" outlined clearable dense></v-text-field>
                  </v-col>
                  <v-col cols="12">
                    <v-card outlined rounded="lg">
                      <v-radio-group v-model="from.ruleType" row id="radio-group" dense>
                        <v-radio v-for="n in 3" :key="n" :label="text.labels[n-1]" v-show="!bypass||n!==1"></v-radio>
                      </v-radio-group>
                    </v-card>
                  </v-col>
                  <v-col cols="12" class="my-6">
                    <v-btn color="success" block elevation="1" @click="install" :disabled="!from.url" v-text="text.btn"></v-btn>
                  </v-col>
                </v-row>
              </v-card-text>
            </v-card>
          </v-container>
        </v-main>
      </v-app>
    </div>
    <script>
      new Vue({
        el: '#app',
        vuetify: new Vuetify(),
        data: {
          from: {
            url: '',
            add: '',
            host: '',
            filter: '',
            ruleType: 1
          },
          bypass: false, // 分流
          text: {
            header: 'clash-sub',
            btn: '导入到 Clash',
            labels: ['全代理', '白名单', '黑名单']
          }
        },
        created() {
          this.getData() && ({ ...this.from } = { ...this.getData() })
        },
        methods: {
          onClick() {
            this.bypass = !this.bypass
            if (this.from.ruleType === 0) {
              this.from.ruleType = 1
            }
          },
          // url=xxx&host=xxx => encodeURI => base64
          getQuery() {
            let query = ''
            for (const [key, value] of Object.entries(this.from)) {
              if (value !== '' && value !== null) {
                query = `${query}&${key}=${value}`
              }
            }
            this.bypass && (query = `${query}&bypass=1`)
            return window.btoa(window.encodeURIComponent(query.replace('&', '')))
          },
          // 保存表单到localStorage中
          saveData() {
            localStorage.setItem('from', JSON.stringify(this.from))
          },
          // 从localStorage中读取数据
          getData() {
            return JSON.parse(localStorage.getItem('from'))
          },
          // 导入到Clash
          install() {
            window.location.href = `clash://install-config?url=${location.origin}/subscribe?${this.getQuery()}`
            this.saveData()
          }
        }
      })
    </script>
    <style>
      #radio-group {
        display: flex;
        justify-content: space-evenly;
      }
    </style>
  </body>
</html>
